#!/bin/sh

# This script is indended to provide GNU autoconf compatible behavior.
# Do not rely too much on it. If unsure, go edit Makefile and/or config.h

# Unlike actualy autoconf scripts, this script does not test anything.
# Testing makes little sense for a small, very linux-specific tool
# like sninit which has no way of handling unusual evironments.

unset target diet cc
unset cctype libc 
unset libs libs_syscall
unset tstype null

lto=
optimize=auto
debug=
builtin=
hostcc=gcc

unset prefix sbindir mandir man5dir man8dir logdir sysconfdir
unset initctl inittab runcap s cgdir blocks run

die() { echo "$@"; exit 1; }
dieifnot() { test -n "$1" && return; shift; die "$@"; }
argreq() { dieifnot "$val" "$arg: value must be supplied"; }

usage() {
cat <<END
Usage: ./configure [options]

Options take either "key" or "key=val" forms.
For compatibility, --key=val and --with-key=val are accepted in most cases.

Installation directories:
	prefix=		overall prefix []
	sbindir=	system binaries directory [\$prefix/sbin]
	sysconfdir=	system configuration directory [\$prefix/etc]
	mandir=		man pages directory [\$prefix/share/man]
	logdir=		log directory [\$prefix/var/log], for spawned processes only

Runtime paths configuration:
	initctl=	init control socket [@initctl]
	inittab=	inittab [\$sysconfdir/inittab]
	initdir=	initdir [\$sysconfdir/initdir]

	disable-initdir	build init without initdir support
	disable-inittab	build init without any kind of runtime configuration

Target configuration:
	target=A	use \$A toolchain; in particular, use \$A-gcc
	build=B		use \$B toolchain for build-time executable
			(build= is only useful with builtin=)
	CC=		C compiler [gcc]
	AS=		assembler [gcc -c]
	AR=		archiver [ar]
			(as and ar are only used for bundled libc)

	lto		use link-time optimization (GCC only)
	debug		generate debug symbols

	devel		disable optimization, generate debug symbols,
			set inittab=etc/inittab and initdir=etc/initdir
			for testing and/or development

	qemu=A		use qemu-A to run tests

Libc selection (see INSTALL for explaination):
	arch=L		use bundled libc for target arch \$L
			possible L values: arm mips x86 x86_64 x86_32
	syslibc		use whatever libc target toolchain was configured with
	dietlibc	build with dietlibc (cc="diet gcc")
	musl		build with musl (cc="musl-gcc")

Init features:
	builtin=F	parse and compile \$F as built-in inittab
			(see doc/builtin.txt)

	tz		put localtime stamps in syslog messages
	utc		put utc timestamps in syslog messages
	nots		do not put any timestamps, rely on syslogd to add them

If not sure about configure usage, check comments in config.mk and config.h,
then edit those files directly.
END
exit 0
}

while [ $# -gt 0 ]; do
	arg="$1"; shift;
	# Separate LHS and RHS in --option=value or VAR=val cases
	case "$arg" in
		*=*)
			val=`echo "$arg" | sed -e 's/^[^=]*=//'`
			arg=`echo "$arg" | sed -e 's/=.*//'`
			;;
		*)
			val="" ;;
	esac

	# Now the arguments. We're aiming at being moderately autoconf-compatible,
	# so "--with-dietlibc" is allowed along with much more logical "dietlibc"
	# There will be some "extra" options like "with-dietlibc" but that's ok.
	#
	# Different name to produce correct error messages,
	# i.e. --foo not foo where --foo was used.

	arq=`echo "$arg" | sed -e 's/^--//'`

	case "$arq" in
		help) usage ;;

		sysconfdir|configdir) sysconfdir=$val ;;
		sbindir) sbindir=$val ;;
		logdir) logdir=$val ;;
		mandir) mandir=$val ;;
		man5dir) mandir=$val ;;
		man8dir) mandir=$val ;;
		prefix) prefix=$val ;;
		cgdir) cgdir=$val ;;

		program-prefix) s=$val ;;
		with-s|s) s=s ;;
		with-sn|sn) s=sn ;;

		initctl) argreq
			initctl=$val
			;;
		inittab) argreq
			inittab=$val
			;;
		initdir) argreq
			initdir=$val
			;;
		builtin|with-builtin) argreq
			builtin="$val"
			;;
		target|host) argreq
			target=$val
			cross=$target-
			;;
		build) argreq
			build=$val
			hostcc=$val-gcc
			;;
		with-cc|cc|CC)
			cc=${val:-cc}
			cctype=gcc
			;;
		with-as|as|AS) argreq
			AS=$val
			;;
		with-ar|ar|AR) argreq
			AR=$val
			;;
		with-clang|clang)
			cc=${val:-clang}
			cctype=clang
			;;
		arch|bundled|with-bundled|with-bundled-libc) argreq
			libc=bundled
			arch="$val"
			;;
		with-musl|musl)
			cctype=musl
			;;
		with-dietlibc|dietlibc) argreq
			diet=${val:-diet}
			libc=dietlibc
			;;
		with-dietlibc-fixed|dietlibc-fixed)
			# fixed = with ppoll(2) support
			diet=${val:-diet}
			libc=dietlibc-fixed
			;;
		with-libc|libc)
			libc=${val:-syslibc}
			;;
		with-syslibc|with-glibc|syslibc|glibc|libc)
			libc=syslibc
			;;
		with-timestamps|ts) argreq
			tstype=$val
			;;
		tz|notz|libcts|nots)
			tstype=$arq
			;;
		disable-inittab|no-inittab)
			inittab=-
			;;
		disable-initdir|no-initdir)
			initdir=-
			;;
		enable-debug|debug)
			debug=${val:-"-Wall -g"}
			;;
		enable-lto|lto)
			lto=${val:-"-flto"}
			;;
		disable-optimization|no-O)
			optimize=
			lto=
			;;
		with-optimization|O|optimize)
			optimize=${val:-$optimize}
			;;
		devel)
			s=
			inittab=etc/inittab
			initdir=etc/initdir
			logdir=var/log
			optimize=
			debug="-Wall -g"
			;;
		run|RUN) argreq
			run="$val"
			;;
		qemu)
			test -n "$val" && run="qemu-$val" || run="auto"
			;;
		*)
			die "Unknown option $arg"
			;;
	esac
done

# Could be done in the loop above, if not for option order issues.
# i.e. --with-clang --with-dietlibc vs --with-dietlibc --with-clang

test "$target" = "$build" || HOSTCC=${HOSTCC:-$hostcc}

case "${cctype:-gcc}" in
	# gcc handles target with prefixed executables, like arm-linux-eabi-gcc
	gcc)	CC=${cc:-${cross}gcc} ;;
	cc)	CC=${cc:-${cross}cc} ;;
	# clang makes no difference between native and cross-compilation, and only needs
	# an option to select desired arch.
	clang)
		CC=${cc:-clang}
		[ -n "$target" ] && CC="$CC -arch $target"
		;;
	# Unlike dietlibc, musl replaces compiler.
	# No idea how they handle cross-builds, perhaps with different musl-executables?
	musl)
		CC=${cc:-musl-gcc}
		[ -n "$target" ] && die -e "Can't use --host/--target with musl\n"\
			"Use --with-musl=ARCH-musl-gcc or something similar instead."
		;;
esac

# Check if we're trying to build x86 on an x86_64 host
# It's a blind test but that's ok since unrecognized option
# message is not likely to start with x86_64
#
# XXX: it's a dirty hack that should be done differently
if [ "$arch" == "x86" -a -z "$target" -a -z "$cc" ]; then
	case "$ccarch" in
		x86_64*)
			CC="$CC -m32 -march=i686"
			test -z "$HOSTCC" && HOSTCC="$hostcc"
			;;
	esac
elif [ "$arch" == "x86_32" -a -z "$target" -a -z "$cc" ]; then
	# Assuming native x86_32 compilers are non-existant
	CC="$CC -mx32"
	test -z "$HOSTCC" && HOSTCC="$hostcc"
fi

# Try to guess target architecture
# This should be done *after* deciding $CC of course
ccarch=`$CC -dumpmachine 2>/dev/null`
test -z "$ccarch" -a -n "$target" && ccarch="$target"

# Handle optimization
if [ "$optimize" == 'auto' ]; then
	case "$ccarch" in
		# stdarg + x86 + SSE results in xmm* register handling bloat
		# despite the fact those are never used in sninit
		x86*) optimize="-Os -mno-sse" ;;
		# without any better ideas, just optimize for size
		*) optimize="-Os" ;;
	esac
fi

if [ -n "$optimize" ]; then
	cflags=${cflags:+$cflags }$optimize
fi
if [ -n "$lto" ]; then
	cflags=${cflags:+$cflags }$lto
	ldflags=${ldflags:+$ldflags }$lto
fi
if [ -n "$debug" ]; then
	cflags=${cflags:+$cflags }$debug
fi


if [ "$inittab" != "-" ]; then
	blocks="conf"
else
	blocks="null"
fi

# See if we'd like to use bundled libc by default
case "$libc:$arch:$ccarch" in
	::x86_64*) libc=bundled arch=x86_64 ;;
	# x86_32 is *not* reported as such and must be specified explicitly!
	::x86*) libc=bundled arch=x86 ;;
	::arm*) libc=bundled arch=arm ;;
	::mips64*) ;;
	::mips*) libc=bundled arch=mips ;;
esac

case "${libc:-syslibc}" in
	bundled)
		dieifnot "$arch" "Target architecture must be specified for bundled libc (--arch)"
		test -d "libc/$arch" || die "bundled libc: target $arch is not supported"
		blocks="$blocks sys"
		tsdefault=tz
		;;
	musl)
		tsdefault=libc
		;;
	syslibc)
		blocks="$blocks dents"
		tsdefault=libc
		;;
	dietlibc-fixed)
		CC="$diet $CC"
		blocks="$blocks sys"
		tsdefault=tz
		;;
	dietlibc)
		CC="$diet $CC"
		libs=-lcompat
		blocks="$blocks sys ppoll"
		tsdefault=tz
		;;
	*)
		die "Unknown libc type $libc"
		;;
esac

case "${tstype:-$tsdefault}" in
	libc)
		blocks="$blocks libcts"
		;;
	null)
		blocks="$blocks nots"
		;;
	tz)
		blocks="$blocks tz"
		;;
	notz|utc)
		blocks="$blocks notz"
		;;
esac

# Try to guess which qemu to use if this was requested
if [ "$run" == 'auto' ]; then
	cclead=`echo "$ccarch" | sed -e 's/-.*//' -e 's/[^A-Za-z0-9_-]//'`
	if [ -z "$cclead" -a -n "$target" ]; then
		cclead=`echo "$target" | sed -e 's/-.*//'`
	fi
	qemu="qemu-$cclead"
	if "$qemu" -version >& /dev/null; then
		run="$qemu"
	elif [ -n "$cclead" ]; then
		die "Can't find qemu for $cclead"
	else
		die "Can't guess target architecture for qemu"
	fi
fi

# Allow complete overwriting for these variables
CFLAGS=${CFLAGS:-$cflags}
LDFLAGS=${LDFLAGS:-$ldflags}
LIBS=${LIBS:-$libs}
RUN=${RUN:-$run}

AS=${AS:-\$(CC) -c}
AR=${AR:-ar}

# Default values for directory options, defined late because of $prefix dependency
subprefix=${prefix:-/usr}
prefix=${prefix:-/}
test "$prefix" = '/' && prefix=''
mandir=${mandir:-$subprefix/share/man}
man5dir=${man5dir:-$mandir/man5}
man8dir=${man8dir:-$mandir/man8}
sbindir=${sbindir:-$prefix/sbin}
logdir=${logdir:-$prefix/var/log}
cgdir=${cgdir:-/sys/fs/cgroup}
sysconfdir=${sysconfdir:-$prefix/etc}
initctl=${initctl:-@initctl}
test "$inittab" != '-' && inittab=${inittab:-$sysconfdir/inittab} || unset inittab
test "$initdir" != '-' && initdir=${initdir:-$sysconfdir/rc}      || unset initdir

sed -i \
	-e "/^ARCH :=/s#:=.*#:= $arch#"\
	-e "/^CC :=/s#:=.*#:= $CC#"\
	-e "/^AS :=/s#:=.*#:= $AS#"\
	-e "/^AR :=/s#:=.*#:= $AR#"\
	-e "/^CFLAGS :=/s#:=.*#:= $CFLAGS#"\
	-e "/^LDFLAGS :=/s#:=.*#:= $LDFLAGS#"\
	-e "/^LIBS :=/s#:=.*#:= $LIBS#"\
	-e "/^builtin :=/s#:=.*#:= $builtin#"\
	-e "/^HOSTCC :=/s#:=.*#:= $HOSTCC#"\
	-e "/^RUN :=/s#:=.*#:= $RUN#"\
	-e "/^s :=/s#:=.*#:= $s#"\
	-e "/^initblocks :=/s#:=.*#:= $blocks#"\
	config.mk

unset nt; test -z "$inittab" && nt="//"
unset nd; test -z "$initdir" && nd="//"
sed -i \
	-e "/^.*#define INITTAB/s@.*@$nt#define INITTAB \"$inittab\"@" \
	-e "/^.*#define INITDIR/s@.*@$nd#define INITDIR \"$initdir\"@" \
	-e "/#define LOGDIR/s#\".*#\"$logdir\"#" \
	-e "/#define INITCTL/s#\".*#\"$initctl\"#" \
	config.h

sed -i \
	-e "/#define CGBASE/s#\".*#\"$cgdir\"#" \
	runcap.c

echo "Configuration updated. Check the values below, then run make."
echo
test -n "$arch" && \
 echo "	ARCH=$arch"
echo "	CC=$CC"
test -n "$arch" -a "$AS" != "\$(CC) -c" && \
 echo "	AS=$AS"
echo "	CFLAGS=$CFLAGS"
echo "	LDFLAGS=$LDFLAGS"
echo "	LIBS=$LIBS"
test -n "$RUN" && \
 echo "	RUN=$RUN"
echo
echo "	initblocks: $blocks"
echo
echo "	inittab location: $inittab"
echo "	initdir location: $initdir"
echo "	control socket name: $initctl"
echo "	logdir location: $logdir"
echo "	cgroups mount path: $cgdir"
echo
echo "	binaries path: $sbindir"
echo "	executable names: ${s}init ${s}telinit ${s}runcap"
echo "	man section 5 path: $man5dir"
echo "	man section 8 path: $man8dir"
echo
